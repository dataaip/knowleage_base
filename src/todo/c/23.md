# C23 标准

## 概述

**ISO/IEC 9899:2024**（又称 **C23**）是 C 语言标准的最新修订版。该标准在 C17 标准的基础上进行了多项改进，包括引入新的语言特性和库特性，并移除了或弃用了某些过时或不安全的特性。

- **最新公开可用的工作草案**: [n3435](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n3435.pdf) (2025-01-03)
- **最新工作草案**: [n3149](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n3149.zip) (2023-07-09，密码保护的 zip 存档，参见 [n3150](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n3150.pdf))

## 版本历史

| 版本 | 发布日期 | 主要特性 |
|------|----------|----------|
| C89  | 1989     | 初版     |
| C95  | 1995     | 修正     |
| C99  | 1999     | 变量长度数组、内联函数等 |
| C11  | 2011     | 原子操作、多线程支持等 |
| C17  | 2017     | 泛型选择、匿名结构体成员等 |
| C23  | 2024     | 十进制浮点、精确位宽整数、UTF-8 支持等 |

## 废弃特性

### 移除的特性

1. **旧式函数声明和定义**
   - 旧式 K&R 函数声明方式将不再被支持，必须使用 ANSI C 风格的声明。
   - 示例：
     ```c
     // 旧式函数声明
     int add(a, b) int a; int b; { return a + b; }
     
     // 新式函数声明
     int add(int a, int b) { return a + b; }
     ```

2. **非二进制补码的有符号整数表示**
   - 确保所有有符号整数使用二进制补码表示，简化了位运算和整数转换。

3. **允许不以 UTF-16/32 编码的 `u/U` 前缀字符常量和字符串字面量**
   - `u` 和 `U` 前缀字符常量和字符串字面量必须以 UTF-16 或 UTF-32 编码。

4. **混合宽字符串字面量连接**
   - 不允许不同编码的宽字符串字面量直接连接。

5. **支持对 `realloc()` 调用时传入零大小**
   - 传入零大小的行为变为未定义，应使用 `free()` 释放内存。

6. **`__alignof_is_defined` 和 `__alignas_is_defined`**
   - 这些宏不再存在，`_Alignof` 和 `alignas` 成为关键字。

7. **`static_assert` 不再作为 `<assert.h>` 中定义的宏**
   - `static_assert` 成为关键字，但可能仍保留为预定义宏以保证兼容性。

8. **`thread_local` 不再作为 `<threads.h>` 中定义的宏**
   - `thread_local` 成为关键字，但可能仍保留为预定义宏以保证兼容性。

### 弃用的特性

1. **`<stdnoreturn.h>`**
   - `_Noreturn` 成为关键字，不再需要包含此头文件。

2. **旧特性测试宏**
   - `__STDC_IEC_559__`, `__STDC_IEC_559_COMPLEX__`
   - 新增更详细的宏 `__STDC_IEC_60559_BFP__`, `__STDC_IEC_60559_DFP__`, `__STDC_IEC_60559_COMPLEX__`。

3. **`_Noreturn` 函数说明符**
   - 替换为关键字 `noreturn`。

4. **`_Noreturn` 属性标记**
   - 同样替换为关键字 `noreturn`。

5. **`asctime()`, `ctime()`**
   - 不再推荐使用，建议使用 `asctime_s`, `ctime_s` 等安全版本。

6. **`DECIMAL_DIG`**
   - 使用类型特定的宏，如 `FLT_DECIMAL_DIG`。

7. **在 `<math.h>` 中定义的数值限制宏**
   - 如 `INFINITY`, `NAN` 等，建议通过 `<float.h>` 使用。

8. **`__bool_true_false_are_defined`**
   - 与 C99 中引入的 `_Bool` 类型相关，不再需要此宏。

## 新语言特性

### 十进制浮点类型

1. **`_Decimal32`, `_Decimal64`, `_Decimal128`**
   - 提供十进制浮点类型，符合 IEEE 754-2008 标准。
   - 示例：
     ```c
     _Decimal64 x = 123.456;
     ```

### 精确位宽整数

1. **`_BitInt(N)`**
   - 提供精确位宽的整数类型，`N` 为位宽。
   - 示例：
     ```c
     _BitInt(64) large_int = 123456789012345LL;
     ```

### 二进制整数常量

1. **二进制前缀 `0b` 或 `0B`**
   - 支持二进制常量表示法。
   - 示例：
     ```c
     int binary_num = 0b1010; // 10
     ```

### `u8` 字符常量和字符串字面量

1. **`u8` 前缀**
   - 表示 UTF-8 编码的字符和字符串。
   - 示例：
     ```c
     char8_t u8_char = u8'あ';
     char8_t u8_str[] = u8"こんにちは";
     ```

### 数字分隔符 `'`

1. **用于提高大数字的可读性**
   - 示例：
     ```c
     int big_number = 1'000'000'000;
     ```

### 空初始化器 `={}`

1. **用于初始化所有类型为默认值**
   - 示例：
     ```c
     struct Point { int x, y; };
     struct Point p = {};
     ```

### 属性

1. **`[[deprecated]]`**
   - 标记已弃用的函数或变量。
   - 示例：
     ```c
     [[deprecated("Use new_function instead")]] void old_function();
     ```

2. **`[[fallthrough]]`**
   - 明确表示 switch 语句中 case 之间的有意贯穿。
   - 示例：
     ```c
     switch (value) {
         case 1:
             // ...
             [[fallthrough]];
         case 2:
             // ...
             break;
     }
     ```

3. **`[[maybe_unused]]`**
   - 告知编译器变量或函数可能未使用，避免警告。
   - 示例：
     ```c
     [[maybe_unused]] int unused_var = 0;
     ```

4. **`[[nodiscard]]`**
   - 标记函数返回值不应被忽略。
   - 示例：
     ```c
     [[nodiscard]] int check_error() { return -1; }
     ```

5. **`[[noreturn]]`**
   - 标记函数不会返回。
   - 示例：
     ```c
     [[noreturn]] void exit_program() { exit(1); }
     ```

6. **`[[reproducible]]`**
   - 声明函数的结果是可重现的。

7. **`[[unsequenced]]`**
   - 标记操作顺序未定义。

### 函数定义中的未命名参数

1. **允许函数定义中省略参数名**
   - 示例：
     ```c
     int add(int, int);
     ```

### 数组类型与其元素类型的 cvr 限定保持一致

1. **确保数组和其元素的 const/volatile/restrict 限定一致**

### 单参数 `_Static_assert`

1. **简化 `_Static_assert` 使用**
   - 示例：
     ```c
     _Static_assert(sizeof(int) >= 4);
     ```

### `nullptr` 常量及关联的 `nullptr_t` 类型

1. **提供空指针常量**
   - 示例：
     ```c
     void *ptr = nullptr;
     ```

### `true` 和 `false` 成为关键字

1. **布尔常量**
   - 示例：
     ```c
     bool flag = true;
     ```

### 新预处理指令

1. **`#elifdef` 和 `#elifndef`**
   - 条件编译指令。
   - 示例：
     ```c
     #ifdef DEBUG
         printf("Debug mode\n");
     #elifdef RELEASE
         printf("Release mode\n");
     #endif
     ```

2. **`#warning`**
   - 生成编译警告信息。
   - 示例：
     ```c
     #warning "This is a warning"
     ```

3. **`#embed`**
   - 直接嵌入文件内容到程序中。
   - 示例：
     ```c
     #embed "data.txt" -> char data[];
     ```

### 舍入方向的编译指示

1. **`STDC FENV_ROUND` 和 `STDC FENV_DEC_ROUND`**
   - 控制浮点数舍入模式。

## 新库特性

### 新头文件

1. **`<stdbit.h>`**
   - 提供位操作函数。

2. **`<stdckdint.h>`**
   - 提供带检查的整数算术函数。

### 库特性

#### 十进制浮点数学函数

1. **现有和新增浮点数学函数的 `dN` 变体**
   - 如 `sin_d64` 对应 `sin` 函数的 `_Decimal64` 版本。

2. **`quantizedN()`, `samequantumdN()`, `quantumdN()`, `llquantexpdN()`, `encodedecdN()`, `decodedecdN()`, `encodebindN()`, `decodebindN()`**
   - 提供十进制浮点数的量化和编码解码功能。

#### 浮点格式化函数

1. **支持新的格式说明符**
   - 用于处理 `_Decimal32`, `_Decimal64`, `_Decimal128` 类型。

#### 对 UTF-8 的库支持

1. **`char8_t` 类型别名**
   - 表示 UTF-8 编码的字符。

2. **`mbrtoc8()`, `c8rtomb()`**
   - 字符集转换函数。

3. **`atomic_char8_t` 类型别名**
   - 原子操作的 UTF-8 字符类型。

4. **`ATOMIC_CHAR8_T_LOCK_FREE` 测试宏**
   - 测试 `atomic_char8_t` 是否为锁自由的。

#### `memset_explicit()`

1. **安全地清零内存**
   - 防止优化导致的安全漏洞。

#### POSIX 函数

1. **`memccpy()`, `strdup()`, `strndup()`, `gmtime_r()`, `localtime_r()`, `strftime()` 和 `wcsftime()` 的扩展**
   - 提供更多的线程安全版本和功能增强。

#### `fscanf()` 和 `fprintf()` 函数族的扩展

1. **新的长度修饰符**
   - 如 `wN`, `wfN` 用于 `[u]intN_t` 和 `[u]int_fastN_t` 类型。
   - `H`, `D`, `DD` 用于 `_Decimal32`, `_Decimal64`, `_Decimal128` 类型。
   - `b` 用于无符号整数类型。

#### `timespec_getres()`

1. **获取 `timespec` 结构的时间精度**

#### 整数类型宽度的宏常量

1. **如 `INT8_MAX`, `UINT64_C` 等**

#### 浮点类型的附加数值限制宏

1. **如 `FLT_MAX`, `DBL_MIN` 等**

#### 库版本测试宏

1. **如 `__STDC_VERSION_FENV_H__`, `__STDC_VERSION_MATH_H__` 等**

## 缺陷报告

- **C23 中修复的缺陷报告**
  - 包括 DR 440, DR 432, DR 467, DR 476, DR 482, DR 488, DR 489, DR 494, DR 496, DR 497, DR 499, DR 500, DR 501

## 编译器支持

### C23 核心语言特性

| 特性                             | 提案编号 | GCC | Clang | MSVC | Apple Clang | EDG eccp | Intel C++ | Nvidia HPC C++ (原 PGI)* | Nvidia nvcc | Cray |
|----------------------------------|----------|-----|-------|------|-------------|----------|-----------|--------------------------|-------------|------|
| 无消息的 `static_assert`           | N2265    | 9   | 9     | 是   | 是          | 6.5      | 2021.1.2  |                          |             |      |
| `[[nodiscard]]`                    | N2267    | 10  | 9     |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| `[[maybe_unused]]`                 | N2270    | 10  | 9     |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| `[[deprecated]]`                   | N2334    | 10  | 9     |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| 属性语法                         | N2335 N2554 | 10 | 9     |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| IEEE 754 十进制浮点类型          | N2341    | 4.2 (部分)* 12 |  |  |  |  | 13.0 (部分)* |  |  |  |
| `[[fallthrough]]`                | N2408    | 10  | 9     |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| `u8` 字符常量                    | N2418    | 10  | 15    |      |  | 6.5      | 2022.2    |                          |             |      |
| 移除无原型的函数定义             | N2432    | 10  | 15    |      |  |  | 2022.2    |                          |             |      |
| 带消息的 `[[nodiscard]]`         | N2448    | 11  | 10    |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| 函数定义中的未命名参数           | N2480    | 11  | 11    |      | 是          | 6.4      | 2021.1.2  |                          |             |      |
| 声明和块结束前的标签             | N2508    | 11  | 16    | 部分* |  | 6.5      | 17.0*     |                          |             |      |
| 二进制整数常量                   | N2549    | 4.3* 11 | 2.9* 9 | 19.0 (2015)** |  | 6.5      | 11.0*     |                          |             |      |
| 预处理条件中的 `__has_c_attribute` | N2553    | 11  | 9     |      | 是          | 6.5      | 2021.1.2  |                          |             |      |
| 允许重复属性                     | N2557    | 11  | 13    |      | 是          | 6.5      | 2021.4 (基于 clang) |  |  |  |
| IEEE 754 交换和扩展类型          | N2601    | 7 (部分)* 14 | 6 (部分)* |  | 部分* |  |  |  |  |  |
| 数字分隔符                       | N2626    | 12  | 13    | 19.0 (2015)** |  | 6.5      | 18.0*     |                          |             |      |
| `#elifdef` 和 `#elifndef`        | N2645    | 12  | 13    | 19.40* | 13.1.6* | 6.5      | 2021.4    |                          |             |      |
| `u8` 字符串字面量的类型变更      | N2653    | 13  |  |  |  |  |  |  |  |  |
| 标签的 `[[maybe_unused]]`        | N2662    | 11  | 16    |      |  | 6.5      | 2022.2    |                          |             |      |
| `#warning`                       | N2686    | 是  | 是    |      | 是          | 6.5      | 是        |                          |             |      |
| 精确位宽整数类型（`_BitInt`）    | N2763    | 14 (部分)* | 15 |  |  | 6.5      | 2022.2    |                          |             |      |
| `[[noreturn]]`                   | N2764    | 13  | 15    |      |  | 6.5      | 2022.2    |                          |             |      |
| 精确位宽整数常量的后缀           | N2775    | 14  | 15    |      |  |  | 2022.2    |                          |             |      |
| 预处理条件中的 `__has_include`   | N2799    | 5   | 是    | 19.11* | 是          | 6.5      | 18.0      |                          |             |      |
| 使用 Unicode 标准附录 31 的标识符语法 | N2836    | 13  | 15    |      |  | 6.5      | 2022.2    |                          |             |      |
| 移除无原型的函数声明             | N2841    | 13  | 15    |      |  |  | 2022.2    |                          |             |      |
| 空初始化器                       | N2900    | 部分* 13 | 部分* |  | 部分* | 部分* | 部分* |  |  |  |
| `typeof` 和 `typeof_unqual`      | N2927 N2930 | 部分* 13 | 部分* 16 | 19.39* | 部分* | 部分* | 部分* |  |  | 部分* |
| 关键字的新拼写                   | N2934    | 13  | 16    |      |  | 6.5      |  |  |  |  |
| 预定义的 `true` 和 `false`       | N2935    | 13  | 15    |      |  |  | 2022.2    |                          |             |      |
| `[[unsequenced]]` 和 `[[reproducible]]` | N2956 | 15  |  |  |  |  |  |  |  |  |
| 放宽可变参数列表的要求           | N2975    | 13  | 16    |      |  | 6.5      | 2023.1    |                          |             |      |
| 对象定义中的类型推断             | N3007    | 13  | 18    |      |  |  |  |  |  |  |
| `#embed`                         | N3017    | 15  | 19    |      |  |  |  |  |  |  |
| `constexpr` 对象                 | N3018    | 13  | 19    |      |  |  |  |  |  |  |
| 改进的常规枚举                   | N3029    | 13  | 20*   |      |  |  |  |  |  |  |
| 固定底层类型的枚举               | N3030    | 13  | 20*   |      |  |  |  |  |  |  |
| `__VA_OPT__`                     | N3033    | 8 13 | 12    | 19.39* |  | 6.5      |  |  |  |  |
| 复合字面量的存储类说明符         | N3038    | 13  |  |  |  |  |  |  |  |  |
| `nullptr`                        | N3042    | 13  | 16    |      |  |  |  |  |  |  |

### C23 库特性

| 特性                             | 提案编号 | GCC | Clang | MSVC | Apple Clang | EDG eccp | Intel C++ | Nvidia HPC C++ (原 PGI)* | Nvidia nvcc | Cray |
|----------------------------------|----------|-----|-------|------|-------------|----------|-----------|--------------------------|-------------|------|
| 十进制浮点数学函数               |          | 14 (部分)* |  |  |  |  |  |  |  |  |
| 浮点格式化函数                   |          | 14  |  |  |  |  |  |  |  |  |
| 对 UTF-8 的库支持                |          | 14  |  |  |  |  |  |  |  |  |
| `memset_explicit()`              |          | 14  |  |  |  |  |  |  |  |  |
| POSIX 函数                       |          | 14  |  |  |  |  |  |  |  |  |
| `fscanf()` 和 `fprintf()` 函数族的扩展 |  | 14  |  |  |  |  |  |  |  |  |
| `timespec_getres()`              |          | 14  |  |  |  |  |  |  |  |  |
| 整数类型宽度的宏常量             |          | 14  |  |  |  |  |  |  |  |  |
| 浮点类型的附加数值限制宏         |          | 14  |  |  |  |  |  |  |  |  |
| 库版本测试宏                     |          | 14  |  |  |  |  |  |  |  |  |

## 参考资料

- [cppreference.com](https://en.cppreference.com/w/c/23)
- [ISO/IEC 9899:2024](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n3435.pdf)

---

本文档旨在全面、准确地介绍 C23 标准的各项特性及其变化，以帮助开发者更好地理解和应用最新的 C 语言标准。